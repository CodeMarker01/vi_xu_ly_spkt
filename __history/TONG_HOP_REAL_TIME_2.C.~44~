#include <tv_pickit2_shift_1.c>
#include <TV_PICKIT2_SHIFT_DS13B07_I2C.c>
#include <tv_pickit2_shift_glcd128x64.c>
#INCLUDE <TV_PICKIT2_SHIFT_KEY4X4_138.C>
#include <graphics.c>


signed INT8 i;
unsigned INT8 dv_giay,ch_giay,ch_phut,dv_phut,dv_gio,ch_gio;
unsigned INT8 dv_ngay,ch_ngay,ch_thang,dv_thang,dv_nam,ch_nam;
char thu1,thu2;
char thu;
int1 tt;
int1 TT_HT;
unsigned int8 MP;

//QUet led dung ngat
VOID HIEN_THI_8LED_7DOAN_QUET_ALL1()
{     
      FOR(TT8LED=0;TT8LED<8;TT8LED++)         
         {           
            XUAT_8LED_7DOAN_QUET_2(TT8LED, LED_7DQ[TT8LED]);
            DELAY_US(900);
            XUAT_8LED_7DOAN_QUET_TAT_LED();  
            GDRAM_VDK_TO_GDRAM_GLCD_ALL ();
         }
}

#INT_timer3

void NGAT_TIMER3 ()
{
   hien_thi_8led_7doan_quet_all1 ();
   set_timer3 (-6000);
}
//End quet led dung ngat
//*******************************************************************
//LED QUET SECTION
void giai_ma_gan_cho_8led_quet()
{
   led_7dq[0] = ma7doan [GIAY_DS13%16];
   led_7dq[1] = ma7doan [GIAY_DS13/16];
   led_7dq[2] = 0XBF;
   led_7dq[3] = ma7doan [PHUT_DS13%16 ];
   led_7dq[4] = ma7doan [PHUT_DS13/16 ];
   led_7dq[5] = 0XBF;
   led_7dq[6] = ma7doan [GIO_DS13%16];
   led_7dq[7] = ma7doan [GIO_DS13/16 ];
}
//END LED QUET
//***********************************************************************

//LCD SECTION
//TO
void lcd_hienthi_so_z_toado_xy(SIGNED int8 lcd_so, x1, y1)
{
   lcd_GOTO_xy(x1,y1);
   FOR (i=0;i<6;i++)
   {
      IF (i==3) lcd_goto_xy(x1+1,y1);
      lcd_data(lcd_so_x[lcd_so][i]);
   }
}

void giaima_hienthi_to()
{
ch_giay=GIAY_DS13/16; 
dv_giay=GIAY_DS13%16; 

ch_phut=PHUT_DS13/16 ;
dv_phut=PHUT_DS13%16 ;

ch_gio=GIO_DS13/16  ;
dv_gio=GIO_DS13%16 ;

}
void HT_DS1307_to( )
{     
      lcd_command(0x82);
      lcd_data("GIO");
      lcd_command(0x88);
      lcd_data("PHUT");
      lcd_command(0x8F);
      lcd_data("GIAY");
      lcd_hienthi_so_z_toado_xy(ch_gio,2,0);lcd_hienthi_so_z_toado_xy(dv_gio,2,3);
      
     // lcd_hienthi_so_z_toado_xy(19,2,6);
      
      lcd_hienthi_so_z_toado_xy(ch_phut,2,7);lcd_hienthi_so_z_toado_xy(dv_phut,2,10);
      
     //  lcd_hienthi_so_z_toado_xy(19,2,12);
       
      lcd_hienthi_so_z_toado_xy(ch_giay,2,14);lcd_hienthi_so_z_toado_xy(dv_giay,2,17);
   
}

// NHO
void giaima_hienthi_nho()
{
ch_giay=GIAY_DS13/16 +0X30;
dv_giay=GIAY_DS13%16 +0X30;

ch_phut=PHUT_DS13/16 +0X30;
dv_phut=PHUT_DS13%16 +0X30;

ch_gio=GIO_DS13/16  +0X30;
dv_gio=GIO_DS13%16  +0X30;

ch_ngay=NGAY_DS13/16 +0X30;
dv_ngay=NGAY_DS13%16 +0X30;

ch_thang=THANG_DS13/16 +0X30;
dv_thang=THANG_DS13%16 +0X30;

ch_nam=NAM_DS13/16 +0X30;
dv_nam=NAM_DS13%16 +0X30;

if (THU_DS13!=1) 
   {
      thu1=THU_DS13 +0X30;
      thu2=0x20;
   }
      ELSE 
      
      {
      thu1='C';
      thu2='N';
      }
      
}

void HT_DS1307_nho ( )
{     
      LCD_COMMAND (0x8C);   
      LCD_DATA(GIO_DS13/16  +0X30);    LCD_DATA(GIO_DS13%16  +0X30);
      LCD_DATA(' ');
      LCD_DATA(PHUT_DS13/16 +0X30);    LCD_DATA(PHUT_DS13%16 +0X30);
      LCD_DATA(' ');
      LCD_DATA(GIAY_DS13/16 +0X30);    LCD_DATA(GIAY_DS13%16 +0X30);
      LCD_COMMAND (0xC6);
      LCD_DATA("THU");
      LCD_DATA(THU_DS13 +0X30); 
      LCD_COMMAND (0xCC);  
      LCD_DATA(NGAY_DS13/16 +0X30);    LCD_DATA(NGAY_DS13%16 +0X30);
      LCD_DATA(' ');
      LCD_DATA(THANG_DS13/16 +0X30);   LCD_DATA(THANG_DS13%16 +0X30);
      LCD_DATA(' ');
      LCD_DATA(NAM_DS13/16 +0X30);     LCD_DATA(NAM_DS13%16 +0X30); 
}

// PHiM NHAN CHUYEN HIEN THI
void phim_nhan()
{

   IF (!input (BT2))
   {
      delay_ms (20) ;
      {
         IF (!input (BT2))
         {
           tt=!tt;
           lcd_command(lcd_clear_display);
            WHILE ( ! input (BT2)) ;
         }
      }
   }
}

VOID HIEN_THI_IMAGE_GLCD()
{

   IF (TT_HT == 0)
   {

   glcd_circle(21, 32, 20, 0, 1);
   glcd_rect(32+20-5,20-5,106-20-5,63,0,1);
   glcd_circle(106, 32, 20, 0, 1);
   gdram_vdk_to_gdram_glcd_all();
   }

   ELSE
   {

   glcd_rect(21, 20-5,55,63, 0, 1);
//!   glcd_rect(32+20-5,20-5,106-20-5,63,0,1);
   glcd_circle(64, 32, 20, 0, 1);
   glcd_rect(93, 20-5, 127,63, 0, 1);
   gdram_vdk_to_gdram_glcd_all();
   }
   
   
   
   hien_thi_8led_7doan_quet_all1 ();
}

void main()
{
   set_up_port_ic_chot();
   setup_lcd () ;
   
   //setup ngat led quet
   setup_timer_3 (T3_internal|T3_div_by_8);
   set_timer3 (-6000);
   enable_interrupts (global);
   enable_interrupts (INT_timer3);   
   //end ngat led quet
   
   doc_thoi_gian_tu_realtime () ;
   
   lcd_command(0x40);
   FOR (i=0;i<64;i++) { lcd_data(lcd_ma_8doan[i]); }
   
   IF (ma_ds13 != ma_ds)
   {
      thiet_lap_thoi_gian_hien_tai () ;
      NAP_THOI_GIAN_HTAI_VAO_DS13B07 () ;
   }
   
   tt=1;
   giaima_hienthi_to();
   HT_DS1307_to ( );

   doc_thoi_gian_tu_realtime();
   giaytam = giay_ds13;

//!   //GLCD
   setup_glcd(glcd_text_mode);
   setup_glcd(glcd_graphic_mode);
   glcd_mau_nen(0);
   glcd_circle(21, 32, 20, 0, 1);
//!   glcd_circle(64, 32, 20, 0, 1);
   glcd_rect(32+20-5,20-5,106-20-5,63,0,1);
   glcd_circle(106, 32, 20, 0, 1);
   gdram_vdk_to_gdram_glcd_all();

   WHILE (true)
   {
      doc_thoi_gian_tu_realtime () ;
      phim_nhan();

      IF (giaytam != giay_ds13)
      {
         giaytam = giay_ds13;
//!         HT_DS1307();
          giai_ma_gan_cho_8led_quet();
          
          if (tt==0)
         {
            giaima_hienthi_nho();
            HT_DS1307_nho ( );
         }
         else 
         {
            giaima_hienthi_to();
            HT_DS1307_to ( );
         }
        
      }
//!       for(int i=0;i<200;i++)
//!       {
//!       hien_thi_8led_7doan_quet();
//!       }
       hien_thi_8led_7doan_quet_all1 ();
       
//!       giaima_hienthi_to();
//!       HT_DS1307_to( );
    
   
//!   setup_glcd(glcd_text_mode);
//!   setup_glcd(glcd_graphic_mode);
//!   glcd_mau_nen(0);
//!   HIEN_THI_IMAGE_GLCD();
//!   GDRAM_VDK_TO_GDRAM_GLCD_ALL ();
//!   
//!   MP = KEY_4X4_DW ();
//!      IF (MP != 0XFF)
//!      {
//!         IF (MP == 10) TT_HT = ~TT_HT;
//!      }
    
    // HIEN THI HINH GLCD
    SETUP_GLCD (GLCD_GRAPHIC_MODE);
    GLCD_MAU_NEN (0);
    HIEN_THI_IMAGE_GLCD();
    GDRAM_VDK_TO_GDRAM_GLCD_ALL ();
    
    // HIEN THI CHU
    glcd_command(glcd_text_mode);
   glcd_command (glcd_addr_line3+1);
   glcd_data (GIO_DS13/16  +0X30);
   glcd_data (GIO_DS13%16  +0X30);
   
   glcd_command(glcd_text_mode);
   glcd_command (glcd_addr_line3 + 3);
   glcd_data (PHUT_DS13/16 +0X30);
   glcd_data (PHUT_DS13%16 +0X30);
    
   glcd_command(glcd_text_mode);
   glcd_command (glcd_addr_line3 + 6);
   glcd_data (GIAY_DS13/16 +0X30);
   glcd_data (GIAY_DS13%16 +0X30);
    
    
    
   }
}

