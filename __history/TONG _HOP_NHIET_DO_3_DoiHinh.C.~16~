
// CHU Y NHIET DO DOI THAP PHAN
#include <tv_pickit2_shift_1.c>
#include <tv_pickit2_shift_ds18b20.c>
#include <TV_PICKIT2_SHIFT_DS13B07_I2C.c>
#include <tv_pickit2_shift_glcd128x64.c>
#include <graphics.c>

UNSIGNED INT8     j, solan=100; 
float  lm35a;
int16 KQ_HT;
int16 TP_CH_35,TP_DV_35,DV_35,CH_35;//lm35
int16 TP_NG,TP_CH,TP_DV,DV,CH;//DS18b20
int1 TT_HINH = 0;

void hienthi_glcd()
{
   glcd_command(glcd_text_mode);
   glcd_command (glcd_addr_line1+1);//NGUYEN LM35
   glcd_data (CH_35 );
   glcd_data (DV_35 );
   
   glcd_command(glcd_text_mode);// NGUYEN DS18B20
   glcd_command (glcd_addr_line1+6);
   glcd_data (CH );
   glcd_data (DV );
   
   glcd_command(glcd_text_mode);//TP LM35
   glcd_command (glcd_addr_line4 +1);
   glcd_data (TP_CH_35);
   glcd_data (TP_DV_35);
    
   glcd_command(glcd_text_mode);//TP DS18B20
   glcd_command (glcd_addr_line4 + 6);
   glcd_data (TP_NG );
   glcd_data (TP_CH );
}

// Ngat 8 led quet
VOID HIEN_THI_8LED_7DOAN_QUET_ALL1()
{     
      FOR(TT8LED=0;TT8LED<8;TT8LED++)         
         {           
            XUAT_8LED_7DOAN_QUET_2(TT8LED, LED_7DQ[TT8LED]);
            DELAY_US(900);
            XUAT_8LED_7DOAN_QUET_TAT_LED();  
            gdram_vdk_to_gdram_glcd_all();
         }
}

#INT_timer3

void NGAT_TIMER3 ()
{
   hien_thi_8led_7doan_quet_all1 ();
   gdram_vdk_to_gdram_glcd_all();
   set_timer3 (-2000);
}
// END ngat 8 led quet

void giai_ma_gan_cho_8led_quet()
{
   led_7dq[0] = ma7doan [GIAY_DS13 % 16];
   led_7dq[1] = ma7doan [GIAY_DS13 / 16];
   led_7dq[2] = 0XBF;
   led_7dq[3] = ma7doan [nguyen % 10 ];
   led_7dq[4] = ma7doan [nguyen / 10 ];
   led_7dq[5] = 0XBF;
   led_7dq[6] = ma7doan [KQ_HT / 100 % 10];
   led_7dq[7] = ma7doan [KQ_HT / 100 / 10 % 10 ];
}
void giaima_lcd_lm35()
{
   TP_DV_35 = KQ_HT%10 +0x30;
   TP_CH_35 = KQ_HT/10%10+0x30;
   DV_35 = KQ_HT/100%10+0x30;
   CH_35 = KQ_HT/1000+0x30;
}

void hienthi_lcd_lm35()
{
   lcd_GOTO_xy(0,0);
   lcd_data("LM35: ");
   lcd_data(CH_35);lcd_data(DV_35);
   lcd_data('.');
   lcd_data(TP_CH_35);lcd_data(TP_DV_35);
}

/////
void giaima_lcd_ds18b20()
{
   TP_DV = tp%10 +0x30;
   TP_CH = tp/10%10+0x30;
   TP_NG = tp/100 +0x30;
   DV = nguyen%10+0x30;
   CH = nguyen/10%10+0x30;
}

void hienthi_lcd_ds18b20()
{
   lcd_GOTO_xy(1,0);
   lcd_data("DS18B20: ");
   lcd_data(CH);lcd_data(DV);
   lcd_data('.');
   lcd_data(TP_NG);lcd_data(TP_CH);lcd_data(TP_DV);
}

void doc_nd_lm35a()
{
   set_adc_channel (0); lm35a = 0;
   FOR (j = 0; j < solan; j++)
   {
      lm35a = lm35a + read_adc () ;
      delay_us (100);
   }

   lm35a = lm35a / 2.046;
   lm35a = lm35a / solan;
   KQ_HT = (INT16) (LM35A * 100);
}

VOID TRON_VUONG()
{
   IF (!INPUT(BT0))
   {
      DELAY_MS(20);
      IF (!INPUT(BT0))
      {
         TT_HINH = ~TT_HINH;
         WHILE (!INPUT(BT0));
      }
   }
}

void main()
{
   set_up_port_ic_chot ();
   setup_adc (adc_clock_div_32);
   setup_adc_ports (an0_to_an1|vss_vdd);
   setup_lcd ();
   khoi_tao_ds18b20 ();
   
   //khoi tao ngat
   setup_timer_3 (T3_internal|T3_div_by_8);
   set_timer3 (-2000);
   enable_interrupts (global);
   enable_interrupts (INT_timer3); 
   
   ds18a_tam = 0;
   
   doc_thoi_gian_tu_realtime ();

   IF (ma_ds13 != ma_ds)
   {
      thiet_lap_thoi_gian_hien_tai ();
      NAP_THOI_GIAN_HTAI_VAO_DS13B07 ();
   }

   doc_thoi_gian_tu_realtime () ;
   giaytam = giay_ds13;
   
   
   setup_glcd(glcd_text_mode);
   setup_glcd(glcd_graphic_mode);
   glcd_mau_nen(0);
//!   glcd_circle(22, 12, 12, 0, 1);
//!   glcd_circle(22, 50, 12, 0, 1);
//!   
//!   glcd_rect (80, 0, 120, 20, 0, 1);
//!   glcd_rect (80, 45, 120, 63, 0, 1);
//!   
//!   gdram_vdk_to_gdram_glcd_all();

   
   WHILE (true)
   {
      doc_nd_lm35a ();
      
      doc_thoi_gian_tu_realtime ();

      IF (giaytam != giay_ds13)
      {
         giaytam = giay_ds13;
         //!         HT_DS1307();
         giai_ma_gan_cho_8led_quet () ;
      }

      IF (touch_present () ){doc_giatri_ds18b20 (); }
      IF (ds18al != ds18a_tam)
      {
         ds18a_tam = ds18al;
         for (INT i = 0; i < 200; i++)
         {
            giai_ma_gan_cho_8led_quet () ;
         }
      }

      
//!      for (INT8 i = 0; i < 200; i++)
//!      {
//!         hien_thi_8led_7doan_quet () ;
//!      }
         hien_thi_8led_7doan_quet_all1 ();

      
      
      giaima_lcd_lm35 () ;
      hienthi_lcd_lm35 () ;
      
      giaima_lcd_ds18b20 () ;
      hienthi_lcd_ds18b20 () ;
      
      
      hienthi_glcd();
      
      IF (TT_HINH == 0)
      {
         SETUP_GLCD (GLCD_GRAPHIC_MODE);
         GLCD_MAU_NEN (0);
         glcd_circle(23, 40, 15, 0, 1);
         glcd_rect(88, 28, 120, 53, 0, 1) ;
         GDRAM_VDK_TO_GDRAM_GLCD_ALL ();
      }
      ELSE
      {
         SETUP_GLCD (GLCD_GRAPHIC_MODE);
         GLCD_MAU_NEN (0);
         glcd_rect(14, 28, 35, 48, 0, 1) ;
         glcd_circle(105, 38, 15, 0, 1);
         GDRAM_VDK_TO_GDRAM_GLCD_ALL ();
      }
      TRON_VUONG();
      
      
   }
}

